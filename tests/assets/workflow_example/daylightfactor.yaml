type: Workflow

name: daylight-factor

inputs:
  parameters:
    - name: worker
      description: Maximum number of workers for executing this workflow.
      value: 1   # this is the default value which can be overwritten
    - name: sensor-grid-path
      description: Relative path to sensor grid from project folder.
  artifacts:
    # This should be an artifacts since the content of the folder will be copied to
    # container for distributed runs
    - name: project-folder
      description: |
        Path to project folder for this study. This will make it easy to use relative
        path for other template inputs.
      path: '.'   # this is the default value which can be overwritten
      task_path: project

operators:
  - name: radiance-operator
    import_from: 'radiance_operator.yaml'
  - name: honeybee-radiance
    import_from: 'honeybee_radiance_operator.json'

templates:

  - name: generate-overcast-sky
    type: function
    description: Generate an overcast sky for daylight factor simulation.
    operator: honeybee-radiance
    inputs:
      parameters:
        - name: project-folder
          value: '.'
      artifacts:
        - name: sky-folder
          path: '{{inputs.parameters.project-folder}}/sky'
          task_path: sky
    command: honeybee radiance sky illuminance 100000 --folder sky
    outputs:
      artifacts:
        - name: sky
          path: '{{inputs.parameters.project-folder}}/sky/100000_lux.sky'
          task_path: sky/100000_lux.sky'

        # Could also copy the sky-folder and just have that be the output artifact
        # - name: sky-folder
        #   path: '{{inputs.parameters.project-folder}}/sky'
        #   task_path: sky


  - name: split-grid
    type: function
    description: Split sensor grid into smaller grids.
    operator: honeybee-radiance
    inputs:
      parameters:
        - name: input-grid
        - name: sensor-count
        - name: output-folder
          value: '.'   # default value
      artifacts:
        - name: sensor-grid
          path: '{{inputs.parameters.input-grid}}'
          task_path: grid-file
    command: |
      honeybee radiance grid split grid-file '{{inputs.parameters.sensor-count}}' --folder grids-folder > grids_list.txt
    outputs:
      parameters:
        - name: grid-list
          path: grids_list.txt'
      artifacts:
        - name: grids
          path: '{{inputs.parameters.output-folder}}'
          task_path: grids-folder

  - name: create-octree
    type: function
    description: |
      Create an octree from a list fo input files. Files should be separated from each
      other by a space.
    operator: radiance-operator
    inputs:
      parameters:
        - name: input-files
          description: Octree input files separated by space. 
        - name: output-file
          description: Path to output octree file.
      artifacts:
        - name: input-files
          path: "{{inputs.parameters.input-file}}"
          task_path: in
    command: oconv -f in > out 
    outputs:
      artifacts:
        - name: octree-file
          path: "{{inputs.parameters.output-file}}"
          task_path: out

  - name: trace-rays-daylight-factor
    type: function
    operator: radiance-operator
    inputs:
      parameters:
        - name: octree-file
        - name: ray-tracing-options
          description: Radiance rtrace options for ray-tracing (e.g. -ab 3 -ad 2480)
          value: '-ab 2'
        - name: grid-file
        - name: output-file
          description: Path to output results file.
      artifacts:
        - name: octree-file
          path: "{{inputs.parameters.octree-file}}"
          task_path: octree.oct
        - name: grid-file
          path: "{{input.parameters.grid-file}}"
          task_path: grid
    command: |
      rtrace -I -h {{inputs.parameters.ray-tracing-options}} octree.oct < grid | rcalc -e $1=(0.265*$1+0.67*$2+0.065*$3)*179/1000 > out
    outputs:
      artifacts:
        - name: result-file
          path: '{{inputs.parameters.output-file}}'
          task_path: out

  - name: merge-results
    type: function
    operator: honeybee-radiance
    inputs:
      parameters:
        - name: base-name
        - name: input-folder
        - name: output-folder
      artifacts:
        - name: input-folder
          path: "{{inputs.parameters.input-folder}}"
          task_path: results-in
    command: honeybee radiance grid merge results-in results .res --folder out
    outputs:
      artifacts:
        - name: result-file
          path: "{{inputs.parameters.output-folder}}/{{inputs.parameters.base-name}}.res"
          task_path: "out/results.res"

flow:
  name: daylight-factor
  tasks:
    - name: generate-overcast-sky
      template: generate-overcast-sky
      arguments:
        parameters:
          - name: project-folder
            value: '{{ workflow.inputs.parameters.project-folder }}'

    - name: split-grid
      template: split-grid
      arguments:
        parameters:
          - name: sensor-count
            value: "{{ workflow.inputs.parameters.sensor-count }}"
          - name: input-grid
            value: "{{ workflow.inputs.parameters.grid-name }}"
          - name: output-folder
            value: "{{ workflow.inputs.parameters.project-folder }}"
    - name: create-octree
      template: create-octree
      dependencies:
        - generate-overcast-sky
      arguments:
        - name: sky-file
          value: "{{ tasks.generate-sky.outputs.artifacts.sky }}"
        - name: scene-files
          value: "{{ workflow.inputs.parameters.scene-files }}"

    - name: trace-rays
      template: trace-rays
      dependencies:
        - create-octree
        - split-grid
      arguments:
        parameters:
          - name: grid
            value: '{{ item }}'
          - name: octree
            value: "{{ tasks.create-octree.outputs.artifacts.octree-file }}"
      loop: "{{tasks.generate-sky.outputs.parameters.split-grid}}"  # loop over the output grids

    - name: merge-results
      template: merge-results
      dependencies:
        - trace-rays
      arguments:
        parameters:
          - name: base-name
            value: "{{ workflow.inputs.parameters.grid-name }}"

# this is not supported in Argo or is it?
# outputs:
#   artifacts:
#     - name: daylight-factor-values
#       path: "{{ tasks.merge-results.outputs.artifacts.result-file }}"
